# Pyxel ダイアログシステム レビュー

## 1. 設計思想 (Design Philosophy)

このダイアログシステムは、Pyxelアプリケーション内で利用可能な、汎用的かつデータ駆動型のUIシステムを構築することを目的としています。

設計の核心は、**UIのレイアウト定義（見た目）と、アプリケーションのロジック（振る舞い）を分離する**という考え方です。これは、WindowsのUI開発におけるリソースファイル（`.rc`）の概念に強くインスパイアされています。

この思想に基づき、以下の原則を掲げています。

*   **データ駆動 (Data-Driven):**
    ダイアログのレイアウト（位置、サイズ、タイトル）や、それに含まれるウィジェット（ラベル、ボタンなど）の情報は、すべて外部の`dialogs.json`ファイルに記述されます。これにより、プログラマはPythonコードを変更することなく、JSONファイルを編集するだけでUIの調整や追加が可能です。

*   **モジュール性 (Modularity):**
    システムは役割ごとに明確にファイル分割されています。
    *   `DialogManager`: システム全体の管理とダイアログの生成を担当。
    *   `Dialog`: 個々のダイアログウィンドウを表現。
    *   `Widget`: ボタンやラベルなどのUI部品を表現。
    *   `main.py`: 上記のシステムを利用するクライアント（アプリケーション本体）。
    この分割により、各コンポーネントの再利用性が高まり、メンテナンスが容易になります。

*   **拡張性 (Extensibility):**
    新しいウィジェット（例：テキストボックス、チェックボックス）を追加したい場合、`widgets.py`に新しいクラスを定義し、`dialog_manager.py`のファクトリに登録するだけで、システムに組み込むことができます。

## 2. ロジックとアーキテクチャ (Logic and Architecture)

本システムは、以下のコンポーネント間の連携によって動作します。

*   `dialogs.json`:
    *   **役割:** すべてのダイアログの設計図。各ダイアログのID、タイトル、サイズ、位置、そして含まれるウィジェットのリストを定義する。
    *   **実体:** JSON形式のテキストファイル。

*   `dialog_manager.py` (`DialogManager` クラス):
    *   **役割:** システムの中枢。オーケストレーター兼ファクトリー。
    *   **動作:**
        1.  起動時に `dialogs.json` を読み込み、すべてのダイアログ定義をメモリに保持します。
        2.  `show(dialog_id)` メソッドが呼ばれると、指定されたIDに対応する定義を基に `Dialog` インスタンスと、それに付随する `Widget` インスタンス群を生成（ファクトリー機能）します。
        3.  生成したダイアログを「アクティブなダイアログ」として保持し、アプリケーションのメインループからの `update` と `draw` の呼び出しを、そのアクティブなダイアログに伝達します。

*   `dialog.py` (`Dialog` クラス):
    *   **役割:** 一つのダイアログウィンドウそのもの。ウィジェットのコンテナ（入れ物）。
    *   **動作:**
        1.  自身の背景、タイトルバー、枠線を描画します。
        2.  自身が保持するウィジェットのリストをループ処理し、各ウィジェットの `update` と `draw` メソッドを呼び出します。座標計算は、ダイアログ自身の位置を基準とした相対座標で行われます。

*   `widgets.py` (各種 `Widget` クラス):
    *   **役割:** UIを構成する最小単位の部品（ラベル、ボタンなど）。
    *   **動作:**
        1.  `LabelWidget` は指定されたテキストを描画します。
        2.  `ButtonWidget` は自身の矩形とテキストを描画するだけでなく、マウスカーソルとのインタラクション（ホバー、クリック）を検知し、自身の状態（`is_hover`など）を更新します。

*   `main.py` (`App` クラス):
    *   **役割:** ダイアログシステムの利用者（クライアント）。
    *   **動作:**
        1.  Pyxelウィンドウを初期化し、`DialogManager`をインスタンス化します。
        2.  `dialog_manager.show()` を呼び出して、表示したいダイアログを要求します。
        3.  Pyxelのメインループ（`update`, `draw`）内で、`DialogManager`の対応するメソッドを呼び出すことに専念します。

## 3. これまでの作業経緯 (Development Process)

1.  **初期要件:** Pyxelでの簡単なウィンドウ表示からスタート。
2.  **システム設計:** 外部ファイル（JSON）でUIを定義する、汎用的なモーダルダイアログシステムの構想を立案。
3.  **データ定義:** `dialogs.json`のフォーマットを設計し、サンプルダイアログを定義したファイルを作成。
4.  **モジュール実装:** ボトムアップ的に、以下の順でコンポーネントを実装。
    *   `widgets.py`: UIの最小部品であるラベルとボタンを実装。
    *   `dialog.py`: ウィジェットを保持するコンテナとなるダイアログクラスを実装。
    *   `dialog_manager.py`: JSONを解釈し、ダイアログとウィジェットを組み立てる管理クラスを実装。
5.  **統合とリファクタリング:** `main.py`を、完成したダイアログシステムを呼び出すだけのシンプルなクライアントとして再構築。
6.  **デバッグ:** 実行時エラー (`AttributeError`) を解決。Pyxelの定義済み色名が存在しなかったため、直接カラーパレットの番号を指定するように `widgets.py` を修正。
7.  **機能実証:** `dialogs.json`に複数のダイアログ定義を追加し、`main.py`からキー入力で表示ダイアログを切り替える機能を実装。これにより、システムの柔軟性と拡張性の高さを実証した。
